<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <title>Tagesangebot Generator</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.16.9/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.7.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip-utils/0.0.2/jszip-utils.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
</head>
<body>
    <link rel="stylesheet" href="tagesdeal-with-csv.css">
    
	<style>
		
	* {
	margin: 0;
	padding: 0;
	}
		
	div#not-found-div {
    padding: 1rem;
    color: red;
    display: flex;
    justify-content: center;
    align-items: center;
	}
	
	/* Return Button */
		
	div#return-button {
    position: relative;
    background-color: #f2f2f2;
    color: black;
    padding: 1rem;
    text-align: left;
    font-weight: bold;
    line-height: 1em;
    border-bottom: 1px solid #ddd;
	z-index: 10000;
	}
		
	#return-button a {
	position: absolute;
	z-index: 10000;
	top: 0;
	left: 0;
	width: 100%;
	height: 100%;
	}
		
	/* Return Button END */
		
	#loading-overlay {
		position: fixed;
		top: 0;
		left: 0;
		width: 100vw;
		height: 100vh;
		background-color: rgba(255, 255, 255, 0.7);
		z-index: 9999;
		display: flex;
		justify-content: center;
		align-items: center;
	}

	#loading-container {
		text-align: center;
	}

	#loading-spinner {
		border: 8px solid #f3f3f3;
		border-top: 8px solid #3498db;
		border-radius: 50%;
		width: 50px;
		height: 50px;
		animation: spin 2s linear infinite;
		margin: 0 auto;
	}

	.loading-text {
		margin-top: 10px;
		font-family: sans-serif;
		font-size: 16px;
		color: #333;
	}

	@keyframes spin {
		0% { transform: rotate(0deg); }
		100% { transform: rotate(360deg); }
	}
		
	#drop-zone.dragover {
    background-color: #f0f8ff;
    border-color: #3498db;
	}
	
	</style>
	
	<div id="loading-overlay" style="display: none;">
    <div id="loading-container">
        <div id="loading-spinner"></div>
        <div class="loading-text">Lade aktuellste CSV-Datei … bitte warten</div>
    </div>
	</div>
	
	<div id="return-button">
		<span><i class="fas fa-arrow-left"></i> Zurück zur Toolübersicht</span>
		<a href="https://chinafreak93.github.io/cs-tools/claudias-tools.html"></a>	
	</div>	
	
    <form id="upload-form">
        <label for="file"><strong>Excel Datei hochladen:</strong></label>
        <input type="file" id="file" name="file" accept=".xlsx">
		<div id="drop-zone" style="margin-top:1rem; padding: 2rem; border: 2px dashed #ccc; text-align: center; cursor: pointer;">
			<i class="fa-solid fa-upload" style="font-size: 2rem; color: #888;"></i><br>
			<strong>Datei hierher ziehen oder klicken zum Auswählen</strong>
		</div>
        <div class="button-row">
            <button class="templateButton" type="button" id="template-button">Vorlagen Excel herunterladen <i class="fa-solid fa-file"></i></button>
            <button class="createExcel" type="button" id="download-button" style="display: none;">Daten herunterladen und bearbeiten <i class="fa-solid fa-edit"></i></button>
            <button class="downloadButton" type="button" id="screenshot-button" style="display: none;">Bilder erstellen und herunterladen <i class="fa-solid fa-download"></i></button>
            <button class="resetButton" type="button" id="reset-button" style="display: none;">Alles löschen <i class="fa-solid fa-trash"></i></button>
        </div>
    </form>
    
    <div id="output"></div>

 <script>
	let csvData = [];
	let excelData = [];
	let displayedData = [];
	let imageElements = [];

	// Zeige den Lade-Overlay an
	document.getElementById('loading-overlay').style.display = 'flex';

	Papa.parse('https://chinafreak93.github.io/cs-tools/shop-data.csv', {
		download: true,
		header: true,
		complete: function(results) {
			csvData = results.data;
			console.log('CSV Daten geladen:', csvData);

			// Verstecke den Lade-Overlay
			document.getElementById('loading-overlay').style.display = 'none';
		}
	});

    document.getElementById('file').addEventListener('change', function(event) {
        const file = event.target.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, { type: 'array' });
                const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                excelData = XLSX.utils.sheet_to_json(firstSheet, { header: 1 });
                
                const headers = excelData[0];
                excelData = excelData.slice(1).map(row => {
                    let obj = {};
                    row.forEach((cell, index) => {
                        obj[headers[index]] = cell;
                    });
                    return obj;
                });

                console.log('Excel Daten geladen:', excelData);

                mergeDataAndGenerateHTML();

                document.getElementById('download-button').style.display = 'inline-block';
                document.getElementById('screenshot-button').style.display = 'inline-block';
                document.getElementById('reset-button').style.display = 'inline-block';
            };
            reader.readAsArrayBuffer(file);
        } else {
            alert('Bitte eine Excel-Datei hochladen.');
        }
    });

async function mergeDataAndGenerateHTML() {
    displayedData = [];
    let notFoundItems = [];

	for (const excelItem of excelData) {
    if (!excelItem || !excelItem.sku) {
        console.log('Ungültiges Excel-Element:', excelItem);
        continue; // Überspringe ungültige Elemente
    }

    const excelSku = excelItem.sku.toString().trim();
    const matchingCsvItems = csvData.filter(item => item.sku.toString().trim() === excelSku);
	if (matchingCsvItems.length > 0) {
		matchingCsvItems.forEach(csvItem => {
			const mergedItem = { ...csvItem, ...excelItem };
			displayedData.push(mergedItem);
		});
	} else {
		console.log('Produkt in CSV nicht gefunden:', excelSku);
		notFoundItems.push(excelSku);
	}
	}

    // Überprüfen, ob das not-found-div bereits existiert, und es ggf. entfernen
    const existingNotFoundDiv = document.getElementById('not-found-div');
    if (existingNotFoundDiv) {
        existingNotFoundDiv.remove();
    }

    // Anzeige der nicht gefundenen Artikelnummern im separaten <p> Element
    if (notFoundItems.length > 0) {
        const notFoundDiv = document.createElement('div');
        notFoundDiv.id = 'not-found-div';
        const notFoundParagraph = document.createElement('p');
        notFoundParagraph.innerHTML = `<strong>Diese Artikelnummern wurden nicht gefunden:</strong> ${notFoundItems.join(', ')}`;
        notFoundDiv.appendChild(notFoundParagraph);

        // Füge das not-found-div zwischen upload-form und output ein
        const uploadForm = document.getElementById('upload-form');
        const outputDiv = document.getElementById('output');
        uploadForm.parentNode.insertBefore(notFoundDiv, outputDiv);
    }

    document.getElementById('output').innerHTML = '';
    imageElements = [];
    for (const item of displayedData) {
        await generateHTML(item);
    }

    document.getElementById('download-button').disabled = false;
    document.getElementById('screenshot-button').disabled = false;
}

    async function generateHTML(product) {
		let energyLabel = '';
		if (product.energy_efficiency_class_range && product.energy_efficiency_class) {
			const range = product.energy_efficiency_class_range.trim().toLowerCase().replace(/\s+/g, '').replace(/\+/g, 'p');
			const cls = product.energy_efficiency_class.trim().toLowerCase().replace(/\s+/g, '').replace(/\+/g, 'p');
			const isLamp = product.category_department && product.category_department.trim().toLowerCase() === 'lampen & leuchten';

			const prefix = isLamp ? 'old-' : '';
			const filename = `${prefix}el-${range}-${cls}.png`;

			energyLabel = `<img class="ee-labels/big/${filename}">`;
		}

        let customLogoElement = '';
        if (product['custom_logo_url']) {
            customLogoElement = `<img class="logo" src="${await getImageAsBase64(product['custom_logo_url'])}">`;
        }

        let productTitle = product.title.split(' - ')[0];
        if (productTitle.startsWith(product.brand)) {
            productTitle = productTitle.slice(product.brand.length).trim();
        }
        
        let brandLogoUrl = product.brand_logo;
        if (!brandLogoUrl) {
            brandLogoUrl = generateFallbackLogoUrl(product.brand);
            product.brand_logo = brandLogoUrl; // Update displayedData with the fallback URL
        }
        brandLogoUrl = await getImageAsBase64(brandLogoUrl);
		
		const rawStrike = parseFloat(product.strikeprice);
		const rawPrice = parseFloat(product.price);

		// 2. Rabatt-Berechnung auf Basis der Rohwerte
		function calculateDiscountPercentage(strike, price) {
			if (strike && price && strike > 0) {
				return Math.floor(((strike - price) / strike) * 100);
			}
			return 0;
		}

		const discountPercentage = calculateDiscountPercentage(rawStrike, rawPrice);
		const percentPlaceholder = `${discountPercentage}%`;

		// 3. ERST danach Preise formatieren
		const formattedStrikePrice = rawStrike ? formatPrice(rawStrike) : '';
		const formattedPrice = formatPrice(rawPrice);

		// 4. Bisherige Logik geht danach normal weiter
		let hasStrikePrice = formattedStrikePrice && discountPercentage > 0;

		let priceBoxClass = 'price-box';
		if (!hasStrikePrice) {
			priceBoxClass += ' no-strikeprice';
		} else if (discountPercentage <= 4) {
			priceBoxClass += ' low-discount';
		}
		
        let htmlContent = `
        <div class="tagesangebot-outer">
            <a href="https://www.mediamarkt.ch/de/product/_-${product.sku}.html" target="_blank" class="tagesangebot-img" data-sku="${product.sku}-${imageElements.length}">
                <div class="slider-inner">
                    <div class="right-side">
                        <img class="prod-img" src="${await getImageAsBase64(product.image_link)}">
                        <div class="prod-info">
                            <div class="prod-info-top">
                                ${energyLabel}
								<div class="${priceBoxClass}">
								<div class="before-price">
									${hasStrikePrice ? `<div class="percent">-${discountPercentage}%</div>` : ''}
									${formattedStrikePrice ? `<span class="strikeprice">CHF ${formattedStrikePrice}</span>` : ''}
								</div>
								<span class="price">CHF ${formattedPrice}</span>
								</div>
                                <span class="brand">${product.brand}</span>
                                <span class="info-1">${productTitle}</span>
                            </div>
                            <div class="outer-logo">
                                <img class="brand-logo" src="${brandLogoUrl}">
                                ${customLogoElement}
                            </div>
                        </div>
                    </div>
                </div>
            </div>
			</a>
        </div>
        `;

        const outputDiv = document.createElement('div');
        outputDiv.innerHTML = htmlContent;
        document.getElementById('output').appendChild(outputDiv);
        imageElements.push(outputDiv.querySelector('.tagesangebot-img'));
    }

    function isValidUrl(string) {
        try {
            new URL(string);
            return true;
        } catch (_) {
            return false;  
        }
    }

    function generateFallbackLogoUrl(brand) {
        brand = brand.toUpperCase().replace(/[^A-Z0-9 ]/g, '');
        return `brandlogos/${brand}.png`;
    }

    async function getImageAsBase64(url) {
        const response = await fetch(url);
        const blob = await response.blob();
        return new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.onloadend = () => resolve(reader.result);
            reader.onerror = reject;
            reader.readAsDataURL(blob);
        });
    }

    function formatPrice(price) {
        if (!price) return '';
        price = price.toString();
        if (price.includes('.')) {
            let [integerPart, decimalPart] = price.split('.');
            if (decimalPart === '0' || decimalPart === '00') {
                return `${integerPart}.-`;
            } else if (decimalPart === '-') {
                return `${integerPart}.-`;
            } else {
                return `${integerPart}.<sup>${decimalPart}</sup>`;
            }
        } else if (price.includes('-')) {
            return price;
        } else {
            return `${price}.-`;
        }
    }

    document.getElementById('download-button').addEventListener('click', function() {
        const requiredFields = ["sku", "brand", "title", "price", "strikeprice", "image_link", "brand_logo", "energy_efficiency_class","energy_efficiency_class_range", "category_department", "custom_logo_url"];

        const formattedData = displayedData.map(item => {
            const newItem = {};
            requiredFields.forEach(field => {
                newItem[field] = item[field] || '';  // Setze den Feldwert auf eine leere Zeichenkette, wenn er nicht vorhanden ist
            });
            return newItem;
        });

        const wb = XLSX.utils.book_new();
        const ws = XLSX.utils.json_to_sheet(formattedData, {header: requiredFields});
        XLSX.utils.book_append_sheet(wb, ws, 'Sheet1');
        XLSX.writeFile(wb, 'displayed_data.xlsx');
    });

	document.getElementById('screenshot-button').addEventListener('click', async function() {
		const zip = new JSZip();

		for (const element of imageElements) {
			const fullSku = element.getAttribute('data-sku'); // z. B. 12345-0, 12345-1

			const canvas = await html2canvas(element, { scale: 1 });
			let dataUrl = canvas.toDataURL('image/jpeg', 1.0);

			let quality = 1.0;
			let base64Data = dataUrl.split(',')[1];
			while (base64Data.length * 0.75 > 150 * 1024 && quality > 0.1) {
				quality -= 0.05;
				dataUrl = canvas.toDataURL('image/jpeg', quality);
				base64Data = dataUrl.split(',')[1];
			}

			zip.file(`${fullSku}.jpg`, base64Data, { base64: true });
		}

		zip.generateAsync({ type: 'blob' }).then(function(content) {
			saveAs(content, 'screenshots.zip');
		});
	});

    document.getElementById('template-button').addEventListener('click', function() {
        const link = document.createElement('a');
        link.href = 'tagesangebot-mit-csv-vorlage.xlsx';
        link.download = 'tagesangebot-mit-csv-vorlage.xlsx';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    });

        document.getElementById('reset-button').addEventListener('click', function() {
            document.getElementById('file').value = '';
            document.getElementById('output').innerHTML = '';
            displayedData = [];
            imageElements = [];
            document.getElementById('download-button').disabled = true;
            document.getElementById('screenshot-button').disabled = true;
            document.getElementById('download-button').style.display = 'none';
            document.getElementById('screenshot-button').style.display = 'none';
            document.getElementById('reset-button').style.display = 'none';
            
            // Entfernt das div mit der ID not-found-div, falls es existiert
            const notFoundDiv = document.getElementById('not-found-div');
            if (notFoundDiv) {
                notFoundDiv.remove();
            }
        });
	 
	 	const dropZone = document.getElementById('drop-zone');

		dropZone.addEventListener('click', () => {
			document.getElementById('file').click();
		});

		dropZone.addEventListener('dragover', (e) => {
			e.preventDefault();
			dropZone.classList.add('dragover');
		});

		dropZone.addEventListener('dragleave', () => {
			dropZone.classList.remove('dragover');
		});

		dropZone.addEventListener('drop', (e) => {
			e.preventDefault();
			dropZone.classList.remove('dragover');

			const files = e.dataTransfer.files;
			if (files.length > 0) {
				document.getElementById('file').files = files;

				const event = new Event('change');
				document.getElementById('file').dispatchEvent(event);
			}
		});
</script>
</body>
</html>
